<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #ddd;
            background: #fafafa;
        }
        .test-item.success {
            border-color: #4CAF50;
            background: #f1f8f4;
        }
        .test-item.error {
            border-color: #f44336;
            background: #ffebee;
        }
        .test-item.pending {
            border-color: #ff9800;
            background: #fff3e0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            font-weight: bold;
            margin-left: 10px;
        }
        .success .status { color: #4CAF50; }
        .error .status { color: #f44336; }
        .pending .status { color: #ff9800; }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
        .summary {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .stat {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 4px;
        }
        .stat.success { background: #f1f8f4; color: #4CAF50; }
        .stat.error { background: #ffebee; color: #f44336; }
        .stat.pending { background: #fff3e0; color: #ff9800; }
        .stat .number {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª QRæ•°æ®ä¼ è¾“ç³»ç»Ÿ - æœ¬åœ°åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ§åˆ¶</h2>
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
    </div>

    <div class="test-section">
        <h2>1. ç¯å¢ƒæ£€æµ‹</h2>
        <div id="env-tests"></div>
    </div>

    <div class="test-section">
        <h2>2. èµ„æºåŠ è½½æµ‹è¯•</h2>
        <div id="resource-tests"></div>
    </div>

    <div class="test-section">
        <h2>3. é¡µé¢è®¿é—®æµ‹è¯•</h2>
        <div id="page-tests"></div>
    </div>

    <div class="test-section">
        <h2>4. QRç åŠŸèƒ½æµ‹è¯•</h2>
        <div id="qr-tests"></div>
    </div>

    <div class="test-section">
        <h2>5. PWAåŠŸèƒ½æµ‹è¯•</h2>
        <div id="pwa-tests"></div>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <h2>æµ‹è¯•æ€»ç»“</h2>
        <div class="stats">
            <div class="stat success">
                <div class="number" id="success-count">0</div>
                <div>æˆåŠŸ</div>
            </div>
            <div class="stat error">
                <div class="number" id="error-count">0</div>
                <div>å¤±è´¥</div>
            </div>
            <div class="stat pending">
                <div class="number" id="pending-count">0</div>
                <div>å¾…æµ‹</div>
            </div>
        </div>
        <div class="test-result" id="summary-message"></div>
    </div>

    <script src="config.js"></script>
    <script src="js/resource-loader.js"></script>
    <script>
        const testResults = {
            success: 0,
            error: 0,
            pending: 0
        };

        function updateTestResult(containerId, testName, status, message) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let testDiv = document.getElementById(testName);
            if (!testDiv) {
                testDiv = document.createElement('div');
                testDiv.id = testName;
                testDiv.className = 'test-item';
                container.appendChild(testDiv);
            }
            
            testDiv.className = `test-item ${status}`;
            testDiv.innerHTML = `
                <strong>${testName}</strong>
                <span class="status">${status.toUpperCase()}</span>
                ${message ? `<div class="test-result">${message}</div>` : ''}
            `;
        }

        function updateSummary() {
            document.getElementById('success-count').textContent = testResults.success;
            document.getElementById('error-count').textContent = testResults.error;
            document.getElementById('pending-count').textContent = testResults.pending;
            document.getElementById('summary').style.display = 'block';
            
            const total = testResults.success + testResults.error + testResults.pending;
            const percentage = total > 0 ? Math.round((testResults.success / total) * 100) : 0;
            
            let message = `æµ‹è¯•å®Œæˆï¼š${total} ä¸ªæµ‹è¯•ï¼ŒæˆåŠŸç‡ ${percentage}%`;
            if (testResults.error === 0 && testResults.pending === 0) {
                message += '\nâœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚';
            } else if (testResults.error > 0) {
                message += `\nâš ï¸ æœ‰ ${testResults.error} ä¸ªæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é—®é¢˜ã€‚`;
            }
            
            document.getElementById('summary-message').textContent = message;
        }

        async function testEnvironment() {
            // æµ‹è¯•æµè§ˆå™¨APIæ”¯æŒ
            const apis = {
                'Service Worker': 'serviceWorker' in navigator,
                'Local Storage': typeof localStorage !== 'undefined',
                'Session Storage': typeof sessionStorage !== 'undefined',
                'IndexedDB': 'indexedDB' in window,
                'Web Workers': typeof Worker !== 'undefined',
                'Fetch API': typeof fetch !== 'undefined',
                'getUserMedia': navigator.mediaDevices && navigator.mediaDevices.getUserMedia
            };
            
            for (const [name, supported] of Object.entries(apis)) {
                updateTestResult('env-tests', name, supported ? 'success' : 'error', 
                    supported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ');
                testResults[supported ? 'success' : 'error']++;
            }
        }

        async function testResources() {
            // æµ‹è¯•æœ¬åœ°åº“æ–‡ä»¶
            const resources = [
                { name: 'QRCodeåº“(æœ¬åœ°)', path: 'libs/qrcode.min.js' },
                { name: 'jsQRåº“(æœ¬åœ°)', path: 'libs/jsQR.js' },
                { name: 'èµ„æºåŠ è½½å™¨', path: 'js/resource-loader.js' },
                { name: 'é…ç½®æ–‡ä»¶', path: 'config.js' },
                { name: 'Service Worker', path: 'service-worker.js' },
                { name: 'Manifest', path: 'manifest.json' }
            ];
            
            for (const resource of resources) {
                try {
                    const response = await fetch(resource.path);
                    if (response.ok) {
                        updateTestResult('resource-tests', resource.name, 'success', 
                            `åŠ è½½æˆåŠŸ (${response.status})`);
                        testResults.success++;
                    } else {
                        updateTestResult('resource-tests', resource.name, 'error', 
                            `åŠ è½½å¤±è´¥ (${response.status})`);
                        testResults.error++;
                    }
                } catch (error) {
                    updateTestResult('resource-tests', resource.name, 'error', 
                        `é”™è¯¯: ${error.message}`);
                    testResults.error++;
                }
            }
            
            // æµ‹è¯•èµ„æºåŠ è½½å™¨åŠŸèƒ½
            try {
                await window.resourceLoader.loadResource('qrcode');
                updateTestResult('resource-tests', 'QRCodeåŠ¨æ€åŠ è½½', 'success', 
                    'QRCodeåº“é€šè¿‡èµ„æºåŠ è½½å™¨æˆåŠŸåŠ è½½');
                testResults.success++;
            } catch (error) {
                updateTestResult('resource-tests', 'QRCodeåŠ¨æ€åŠ è½½', 'error', 
                    `åŠ è½½å¤±è´¥: ${error.message}`);
                testResults.error++;
            }
        }

        async function testPages() {
            const pages = [
                { name: 'ä¸»é¡µ', path: 'index.html' },
                { name: 'å‘é€ç«¯', path: 'sender.html' },
                { name: 'æ¥æ”¶ç«¯', path: 'receiver.html' },
                { name: 'åŸºç¡€æµ‹è¯•', path: 'test.html' },
                { name: 'é«˜çº§æµ‹è¯•', path: 'test-advanced.html' }
            ];
            
            for (const page of pages) {
                try {
                    const response = await fetch(page.path);
                    const text = await response.text();
                    if (response.ok && text.includes('<!DOCTYPE html>')) {
                        updateTestResult('page-tests', page.name, 'success', 
                            `é¡µé¢åŠ è½½æˆåŠŸï¼Œå¤§å°: ${(text.length / 1024).toFixed(2)} KB`);
                        testResults.success++;
                    } else {
                        updateTestResult('page-tests', page.name, 'error', 
                            `é¡µé¢åŠ è½½å¼‚å¸¸`);
                        testResults.error++;
                    }
                } catch (error) {
                    updateTestResult('page-tests', page.name, 'error', 
                        `é”™è¯¯: ${error.message}`);
                    testResults.error++;
                }
            }
        }

        async function testQRFunctions() {
            // æµ‹è¯•QRCodeç”Ÿæˆ
            try {
                if (typeof QRCode !== 'undefined') {
                    const testDiv = document.createElement('div');
                    testDiv.style.display = 'none';
                    document.body.appendChild(testDiv);
                    
                    const qr = new QRCode(testDiv, {
                        text: 'Test QR Code',
                        width: 128,
                        height: 128
                    });
                    
                    updateTestResult('qr-tests', 'QRç ç”Ÿæˆ', 'success', 
                        'QRCodeåº“æ­£å¸¸å·¥ä½œï¼Œå¯ä»¥ç”ŸæˆäºŒç»´ç ');
                    testResults.success++;
                    
                    document.body.removeChild(testDiv);
                } else {
                    updateTestResult('qr-tests', 'QRç ç”Ÿæˆ', 'error', 
                        'QRCodeåº“æœªåŠ è½½');
                    testResults.error++;
                }
            } catch (error) {
                updateTestResult('qr-tests', 'QRç ç”Ÿæˆ', 'error', 
                    `é”™è¯¯: ${error.message}`);
                testResults.error++;
            }
            
            // æµ‹è¯•jsQRæ‰«æåº“
            try {
                await window.resourceLoader.loadResource('jsQR');
                if (typeof jsQR !== 'undefined') {
                    updateTestResult('qr-tests', 'QRç æ‰«æåº“', 'success', 
                        'jsQRåº“åŠ è½½æˆåŠŸ');
                    testResults.success++;
                } else {
                    updateTestResult('qr-tests', 'QRç æ‰«æåº“', 'error', 
                        'jsQRåº“æœªå®šä¹‰');
                    testResults.error++;
                }
            } catch (error) {
                updateTestResult('qr-tests', 'QRç æ‰«æåº“', 'error', 
                    `åŠ è½½å¤±è´¥: ${error.message}`);
                testResults.error++;
            }
        }

        async function testPWA() {
            // æµ‹è¯•Service Workeræ³¨å†Œ
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('service-worker.js');
                    updateTestResult('pwa-tests', 'Service Workeræ³¨å†Œ', 'success', 
                        `æ³¨å†ŒæˆåŠŸï¼ŒèŒƒå›´: ${registration.scope}`);
                    testResults.success++;
                } catch (error) {
                    updateTestResult('pwa-tests', 'Service Workeræ³¨å†Œ', 'error', 
                        `æ³¨å†Œå¤±è´¥: ${error.message}`);
                    testResults.error++;
                }
            } else {
                updateTestResult('pwa-tests', 'Service Workeræ³¨å†Œ', 'error', 
                    'æµè§ˆå™¨ä¸æ”¯æŒService Worker');
                testResults.error++;
            }
            
            // æµ‹è¯•manifestæ–‡ä»¶
            try {
                const response = await fetch('manifest.json');
                const manifest = await response.json();
                if (manifest.name && manifest.icons && manifest.start_url) {
                    updateTestResult('pwa-tests', 'PWA Manifest', 'success', 
                        `åº”ç”¨åç§°: ${manifest.name}, å›¾æ ‡: ${manifest.icons.length} ä¸ª`);
                    testResults.success++;
                } else {
                    updateTestResult('pwa-tests', 'PWA Manifest', 'error', 
                        'Manifestæ–‡ä»¶ä¸å®Œæ•´');
                    testResults.error++;
                }
            } catch (error) {
                updateTestResult('pwa-tests', 'PWA Manifest', 'error', 
                    `åŠ è½½å¤±è´¥: ${error.message}`);
                testResults.error++;
            }
            
            // æµ‹è¯•ç¼“å­˜API
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    updateTestResult('pwa-tests', 'Cache API', 'success', 
                        `ç¼“å­˜å¯ç”¨ï¼Œå½“å‰ç¼“å­˜: ${cacheNames.length} ä¸ª`);
                    testResults.success++;
                } catch (error) {
                    updateTestResult('pwa-tests', 'Cache API', 'error', 
                        `è®¿é—®å¤±è´¥: ${error.message}`);
                    testResults.error++;
                }
            } else {
                updateTestResult('pwa-tests', 'Cache API', 'error', 
                    'æµè§ˆå™¨ä¸æ”¯æŒCache API');
                testResults.error++;
            }
        }

        async function runAllTests() {
            // é‡ç½®è®¡æ•°
            testResults.success = 0;
            testResults.error = 0;
            testResults.pending = 0;
            
            console.log('å¼€å§‹è¿è¡Œæµ‹è¯•...');
            
            await testEnvironment();
            await testResources();
            await testPages();
            await testQRFunctions();
            await testPWA();
            
            updateSummary();
            console.log('æµ‹è¯•å®Œæˆï¼', testResults);
        }

        function clearResults() {
            document.getElementById('env-tests').innerHTML = '';
            document.getElementById('resource-tests').innerHTML = '';
            document.getElementById('page-tests').innerHTML = '';
            document.getElementById('qr-tests').innerHTML = '';
            document.getElementById('pwa-tests').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            testResults.success = 0;
            testResults.error = 0;
            testResults.pending = 0;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>