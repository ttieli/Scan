<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #ddd;
            background: #fafafa;
        }
        .test-item.success {
            border-color: #4CAF50;
            background: #f1f8f4;
        }
        .test-item.error {
            border-color: #f44336;
            background: #ffebee;
        }
        .test-item.pending {
            border-color: #ff9800;
            background: #fff3e0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            font-weight: bold;
            margin-left: 10px;
        }
        .success .status { color: #4CAF50; }
        .error .status { color: #f44336; }
        .pending .status { color: #ff9800; }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
        .summary {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .stat {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 4px;
        }
        .stat.success { background: #f1f8f4; color: #4CAF50; }
        .stat.error { background: #ffebee; color: #f44336; }
        .stat.pending { background: #fff3e0; color: #ff9800; }
        .stat .number {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🧪 QR数据传输系统 - 本地功能测试</h1>
    
    <div class="test-section">
        <h2>测试控制</h2>
        <button onclick="runAllTests()">运行所有测试</button>
        <button onclick="clearResults()">清除结果</button>
        <button onclick="location.reload()">重新加载</button>
    </div>

    <div class="test-section">
        <h2>1. 环境检测</h2>
        <div id="env-tests"></div>
    </div>

    <div class="test-section">
        <h2>2. 资源加载测试</h2>
        <div id="resource-tests"></div>
    </div>

    <div class="test-section">
        <h2>3. 页面访问测试</h2>
        <div id="page-tests"></div>
    </div>

    <div class="test-section">
        <h2>4. QR码功能测试</h2>
        <div id="qr-tests"></div>
    </div>

    <div class="test-section">
        <h2>5. PWA功能测试</h2>
        <div id="pwa-tests"></div>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <h2>测试总结</h2>
        <div class="stats">
            <div class="stat success">
                <div class="number" id="success-count">0</div>
                <div>成功</div>
            </div>
            <div class="stat error">
                <div class="number" id="error-count">0</div>
                <div>失败</div>
            </div>
            <div class="stat pending">
                <div class="number" id="pending-count">0</div>
                <div>待测</div>
            </div>
        </div>
        <div class="test-result" id="summary-message"></div>
    </div>

    <script src="config.js"></script>
    <script src="js/resource-loader.js"></script>
    <script>
        const testResults = {
            success: 0,
            error: 0,
            pending: 0
        };

        function updateTestResult(containerId, testName, status, message) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let testDiv = document.getElementById(testName);
            if (!testDiv) {
                testDiv = document.createElement('div');
                testDiv.id = testName;
                testDiv.className = 'test-item';
                container.appendChild(testDiv);
            }
            
            testDiv.className = `test-item ${status}`;
            testDiv.innerHTML = `
                <strong>${testName}</strong>
                <span class="status">${status.toUpperCase()}</span>
                ${message ? `<div class="test-result">${message}</div>` : ''}
            `;
        }

        function updateSummary() {
            document.getElementById('success-count').textContent = testResults.success;
            document.getElementById('error-count').textContent = testResults.error;
            document.getElementById('pending-count').textContent = testResults.pending;
            document.getElementById('summary').style.display = 'block';
            
            const total = testResults.success + testResults.error + testResults.pending;
            const percentage = total > 0 ? Math.round((testResults.success / total) * 100) : 0;
            
            let message = `测试完成：${total} 个测试，成功率 ${percentage}%`;
            if (testResults.error === 0 && testResults.pending === 0) {
                message += '\n✅ 所有测试通过！系统运行正常。';
            } else if (testResults.error > 0) {
                message += `\n⚠️ 有 ${testResults.error} 个测试失败，请检查问题。`;
            }
            
            document.getElementById('summary-message').textContent = message;
        }

        async function testEnvironment() {
            // 测试浏览器API支持
            const apis = {
                'Service Worker': 'serviceWorker' in navigator,
                'Local Storage': typeof localStorage !== 'undefined',
                'Session Storage': typeof sessionStorage !== 'undefined',
                'IndexedDB': 'indexedDB' in window,
                'Web Workers': typeof Worker !== 'undefined',
                'Fetch API': typeof fetch !== 'undefined',
                'getUserMedia': navigator.mediaDevices && navigator.mediaDevices.getUserMedia
            };
            
            for (const [name, supported] of Object.entries(apis)) {
                updateTestResult('env-tests', name, supported ? 'success' : 'error', 
                    supported ? '支持' : '不支持');
                testResults[supported ? 'success' : 'error']++;
            }
        }

        async function testResources() {
            // 测试本地库文件
            const resources = [
                { name: 'QRCode库(本地)', path: 'libs/qrcode.min.js' },
                { name: 'jsQR库(本地)', path: 'libs/jsQR.js' },
                { name: '资源加载器', path: 'js/resource-loader.js' },
                { name: '配置文件', path: 'config.js' },
                { name: 'Service Worker', path: 'service-worker.js' },
                { name: 'Manifest', path: 'manifest.json' }
            ];
            
            for (const resource of resources) {
                try {
                    const response = await fetch(resource.path);
                    if (response.ok) {
                        updateTestResult('resource-tests', resource.name, 'success', 
                            `加载成功 (${response.status})`);
                        testResults.success++;
                    } else {
                        updateTestResult('resource-tests', resource.name, 'error', 
                            `加载失败 (${response.status})`);
                        testResults.error++;
                    }
                } catch (error) {
                    updateTestResult('resource-tests', resource.name, 'error', 
                        `错误: ${error.message}`);
                    testResults.error++;
                }
            }
            
            // 测试资源加载器功能
            try {
                await window.resourceLoader.loadResource('qrcode');
                updateTestResult('resource-tests', 'QRCode动态加载', 'success', 
                    'QRCode库通过资源加载器成功加载');
                testResults.success++;
            } catch (error) {
                updateTestResult('resource-tests', 'QRCode动态加载', 'error', 
                    `加载失败: ${error.message}`);
                testResults.error++;
            }
        }

        async function testPages() {
            const pages = [
                { name: '主页', path: 'index.html' },
                { name: '发送端', path: 'sender.html' },
                { name: '接收端', path: 'receiver.html' },
                { name: '基础测试', path: 'test.html' },
                { name: '高级测试', path: 'test-advanced.html' }
            ];
            
            for (const page of pages) {
                try {
                    const response = await fetch(page.path);
                    const text = await response.text();
                    if (response.ok && text.includes('<!DOCTYPE html>')) {
                        updateTestResult('page-tests', page.name, 'success', 
                            `页面加载成功，大小: ${(text.length / 1024).toFixed(2)} KB`);
                        testResults.success++;
                    } else {
                        updateTestResult('page-tests', page.name, 'error', 
                            `页面加载异常`);
                        testResults.error++;
                    }
                } catch (error) {
                    updateTestResult('page-tests', page.name, 'error', 
                        `错误: ${error.message}`);
                    testResults.error++;
                }
            }
        }

        async function testQRFunctions() {
            // 测试QRCode生成
            try {
                if (typeof QRCode !== 'undefined') {
                    const testDiv = document.createElement('div');
                    testDiv.style.display = 'none';
                    document.body.appendChild(testDiv);
                    
                    const qr = new QRCode(testDiv, {
                        text: 'Test QR Code',
                        width: 128,
                        height: 128
                    });
                    
                    updateTestResult('qr-tests', 'QR码生成', 'success', 
                        'QRCode库正常工作，可以生成二维码');
                    testResults.success++;
                    
                    document.body.removeChild(testDiv);
                } else {
                    updateTestResult('qr-tests', 'QR码生成', 'error', 
                        'QRCode库未加载');
                    testResults.error++;
                }
            } catch (error) {
                updateTestResult('qr-tests', 'QR码生成', 'error', 
                    `错误: ${error.message}`);
                testResults.error++;
            }
            
            // 测试jsQR扫描库
            try {
                await window.resourceLoader.loadResource('jsQR');
                if (typeof jsQR !== 'undefined') {
                    updateTestResult('qr-tests', 'QR码扫描库', 'success', 
                        'jsQR库加载成功');
                    testResults.success++;
                } else {
                    updateTestResult('qr-tests', 'QR码扫描库', 'error', 
                        'jsQR库未定义');
                    testResults.error++;
                }
            } catch (error) {
                updateTestResult('qr-tests', 'QR码扫描库', 'error', 
                    `加载失败: ${error.message}`);
                testResults.error++;
            }
        }

        async function testPWA() {
            // 测试Service Worker注册
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('service-worker.js');
                    updateTestResult('pwa-tests', 'Service Worker注册', 'success', 
                        `注册成功，范围: ${registration.scope}`);
                    testResults.success++;
                } catch (error) {
                    updateTestResult('pwa-tests', 'Service Worker注册', 'error', 
                        `注册失败: ${error.message}`);
                    testResults.error++;
                }
            } else {
                updateTestResult('pwa-tests', 'Service Worker注册', 'error', 
                    '浏览器不支持Service Worker');
                testResults.error++;
            }
            
            // 测试manifest文件
            try {
                const response = await fetch('manifest.json');
                const manifest = await response.json();
                if (manifest.name && manifest.icons && manifest.start_url) {
                    updateTestResult('pwa-tests', 'PWA Manifest', 'success', 
                        `应用名称: ${manifest.name}, 图标: ${manifest.icons.length} 个`);
                    testResults.success++;
                } else {
                    updateTestResult('pwa-tests', 'PWA Manifest', 'error', 
                        'Manifest文件不完整');
                    testResults.error++;
                }
            } catch (error) {
                updateTestResult('pwa-tests', 'PWA Manifest', 'error', 
                    `加载失败: ${error.message}`);
                testResults.error++;
            }
            
            // 测试缓存API
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    updateTestResult('pwa-tests', 'Cache API', 'success', 
                        `缓存可用，当前缓存: ${cacheNames.length} 个`);
                    testResults.success++;
                } catch (error) {
                    updateTestResult('pwa-tests', 'Cache API', 'error', 
                        `访问失败: ${error.message}`);
                    testResults.error++;
                }
            } else {
                updateTestResult('pwa-tests', 'Cache API', 'error', 
                    '浏览器不支持Cache API');
                testResults.error++;
            }
        }

        async function runAllTests() {
            // 重置计数
            testResults.success = 0;
            testResults.error = 0;
            testResults.pending = 0;
            
            console.log('开始运行测试...');
            
            await testEnvironment();
            await testResources();
            await testPages();
            await testQRFunctions();
            await testPWA();
            
            updateSummary();
            console.log('测试完成！', testResults);
        }

        function clearResults() {
            document.getElementById('env-tests').innerHTML = '';
            document.getElementById('resource-tests').innerHTML = '';
            document.getElementById('page-tests').innerHTML = '';
            document.getElementById('qr-tests').innerHTML = '';
            document.getElementById('pwa-tests').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            testResults.success = 0;
            testResults.error = 0;
            testResults.pending = 0;
        }

        // 页面加载完成后自动运行测试
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>