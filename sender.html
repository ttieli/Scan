<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR数据发送器 - 内网数据传输</title>
    <meta name="description" content="通过二维码安全传输内网数据到外部设备">
    <!-- PWA支持 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/x-icon" href="/public/favicon.ico">
    <link rel="apple-touch-icon" href="/public/icons/image.png">
    
    <style>
        /* QR Data Transfer System - Sender Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group textarea,
        .input-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .input-group textarea:focus,
        .input-group input[type="file"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .input-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.9rem;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .qr-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-display canvas {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .qr-placeholder {
            color: #666;
            font-style: italic;
        }

        .progress-section {
            margin-top: 20px;
        }

        .progress-bar {
            background: #ecf0f1;
            border-radius: 20px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.info {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .controls .btn {
            flex: 1;
            min-width: 120px;
        }

        input[type="range"] {
            width: 200px;
            margin: 0 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .section {
                padding: 20px 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            input[type="range"] {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>QR数据发送器</h1>
            <p>通过二维码将内网数据传输到外部设备</p>
        </div>

        <!-- 输入区域 -->
        <div class="section">
            <h2>数据输入</h2>
            
            <div class="input-group">
                <label for="textInput">文本内容</label>
                <textarea 
                    id="textInput" 
                    placeholder="输入要传输的文本... (例如: Hello World)"
                    maxlength="10000"></textarea>
                <small>第一阶段最多支持10,000个字符</small>
            </div>

            <div class="input-group">
                <label for="fileInput">文件上传</label>
                <input type="file" id="fileInput" accept="*/*">
                <small>文件支持将在第三阶段提供</small>
            </div>

            <div class="controls">
                <button class="btn" id="generateBtn">生成二维码</button>
                <button class="btn btn-secondary" id="clearBtn">清除所有</button>
            </div>
        </div>

        <!-- 二维码显示区域 -->
        <div class="section">
            <h2>二维码显示</h2>
            
            <div class="qr-display" id="qrDisplay">
                <div class="qr-placeholder">二维码将在此显示</div>
            </div>

            <div class="controls">
                <button class="btn" id="playBtn" disabled>开始播放</button>
                <button class="btn btn-secondary" id="pauseBtn" disabled>暂停</button>
                <button class="btn btn-secondary" id="stopBtn" disabled>停止</button>
            </div>

            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">帧 0 / 0</div>
            </div>
        </div>

        <!-- 设置区域 -->
        <div class="section">
            <h2>设置</h2>
            
            <div class="input-group">
                <label for="intervalInput">播放间隔 (毫秒)</label>
                <input type="range" id="intervalInput" min="500" max="3000" value="1500" step="100">
                <span id="intervalDisplay">1500ms</span>
            </div>

            <div class="input-group">
                <label for="qrSizeInput">二维码尺寸 (像素)</label>
                <input type="range" id="qrSizeInput" min="128" max="512" value="256" step="32">
                <span id="qrSizeDisplay">256px</span>
            </div>
        </div>

        <!-- 状态区域 -->
        <div class="section">
            <h2>状态</h2>
            <div id="statusContainer">
                <div class="status info">准备生成二维码</div>
            </div>
        </div>
    </div>

    <!-- QRCode.js Library (embedded for offline use) -->
    <script>
        // QRCode.js v1.5.3 - Minimal embedded version for offline use
        // Full library: https://github.com/davidshimjs/qrcodejs
        !function(){var t=function(t,e){this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:d.H},"string"==typeof e&&(e={text:e}),e&&(e.width&&(this._htOption.width=e.width),e.height&&(this._htOption.height=e.height),e.typeNumber&&(this._htOption.typeNumber=e.typeNumber),e.colorDark&&(this._htOption.colorDark=e.colorDark),e.colorLight&&(this._htOption.colorLight=e.colorLight),e.correctLevel&&(this._htOption.correctLevel=e.correctLevel)),this._el=t,this._oQRCode=null,this._htOption.text=e.text,this._htOption.text&&this.makeCode(this._htOption.text)};t.prototype.makeCode=function(t){this._oQRCode=new e(r(t,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(t),this._oQRCode.make(),this._el.title=t,this._el&&(this._el.innerHTML=""),this.makeImage()},t.prototype.makeImage=function(){var t=this._oQRCode,e=this._htOption,r=this._el,o=t.getModuleCount(),i=Math.floor(e.width/o),n=Math.floor(e.height/o);i<=1&&(i=1),n<=1&&(n=1);var a=o*i,h=o*n,s=document.createElement("canvas");s.width=a,s.height=h;for(var l=s.getContext("2d"),u=0;u<o;u++)for(var g=0;g<o;g++){var f=t.isDark(u,g)?e.colorDark:e.colorLight;l.fillStyle=f,l.fillRect(g*i,u*n,i,n)}r&&r.appendChild(s)},t.prototype.clear=function(){this._el.innerHTML=""},t.CorrectLevel=d;var e=function(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]};e.prototype={addData:function(t){var e=new o(t);this.dataList.push(e),this.dataCache=null},isDark:function(t,e){if(t<0||this.moduleCount<=t||e<0||this.moduleCount<=e)throw new Error(t+","+e);return this.modules[t][e]},getModuleCount:function(){return this.moduleCount},make:function(){if(this.typeNumber<1){var t=1;for(t=1;t<40;t++){for(var e=i.getRSBlocks(t,this.errorCorrectLevel),r=new n,o=0,a=0;a<e.length;a++)o+=e[a].dataCount;for(a=0;a<this.dataList.length;a++){var h=this.dataList[a];r.put(h.mode,4),r.put(h.getLength(),s.getLengthInBits(h.mode,t)),h.write(r)}if(r.getLengthInBits()<=8*o)break}this.typeNumber=t}this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(t,e){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var o=0;o<this.moduleCount;o++)this.modules[r][o]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(t,e),this.typeNumber>=7&&this.setupTypeNumber(t),null==this.dataCache&&(this.dataCache=e.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,e)},setupPositionProbePattern:function(t,e){for(var r=-1;r<=7;r++)if(!(t+r<=-1||this.moduleCount<=t+r))for(var o=-1;o<=7;o++)e+o<=-1||this.moduleCount<=e+o||(this.modules[t+r][e+o]=0<=r&&r<=6&&(0==o||6==o)||0<=o&&o<=6&&(0==r||6==r)||2<=r&&r<=4&&2<=o&&o<=4)},getBestMaskPattern:function(){for(var t=0,e=0,r=0;r<8;r++){this.makeImpl(!0,r);var o=s.getLostPoint(this);(0==r||t>o)&&(t=o,e=r)}return e},setupTimingPattern:function(){for(var t=8;t<this.moduleCount-8;t++)null==this.modules[t][6]&&(this.modules[t][6]=t%2==0);for(var e=8;e<this.moduleCount-8;e++)null==this.modules[6][e]&&(this.modules[6][e]=e%2==0)},setupPositionAdjustPattern:function(){for(var t=s.getPatternPosition(this.typeNumber),e=0;e<t.length;e++)for(var r=0;r<t.length;r++){var o=t[e],i=t[r];if(null==this.modules[o][i])for(var n=-2;n<=2;n++)for(var a=-2;a<=2;a++)this.modules[o+n][i+a]=-2==n||2==n||-2==a||2==a||0==n&&0==a}},setupTypeNumber:function(t){for(var e=s.getBCHTypeNumber(this.typeNumber),r=0;r<18;r++){var o=!t&&1==(e>>r&1);this.modules[Math.floor(r/3)][r%3+this.moduleCount-8-3]=o}for(r=0;r<18;r++){o=!t&&1==(e>>r&1);this.modules[r%3+this.moduleCount-8-3][Math.floor(r/3)]=o}},setupTypeInfo:function(t,e){for(var r=this.errorCorrectLevel<<3|e,o=s.getBCHTypeInfo(r),i=0;i<15;i++){var n=!t&&1==(o>>i&1);i<6?this.modules[i][8]=n:i<8?this.modules[i+1][8]=n:this.modules[this.moduleCount-15+i][8]=n}for(i=0;i<15;i++){n=!t&&1==(o>>i&1);i<8?this.modules[8][this.moduleCount-i-1]=n:i<9?this.modules[8][15-i-1+1]=n:this.modules[8][15-i-1]=n}this.modules[this.moduleCount-8][8]=!t},mapData:function(t,e){for(var r=-1,o=this.moduleCount-1,i=7,n=0,a=this.moduleCount-1;a>0;a-=2)for(6==a&&a--;;){for(var h=0;h<2;h++)if(null==this.modules[o][a-h]){var l=!1;n<t.length&&(l=1==(t[n]>>>i&1)),s.getMask(e,o,a-h)&&(l=!l),this.modules[o][a-h]=l,-1==--i&&(n++,i=7)}if((o+=r)<0||this.moduleCount<=o){o-=r,r=-r;break}}}},e.PAD0=236,e.PAD1=17,e.createData=function(t,r,o){for(var a=i.getRSBlocks(t,r),h=new n,l=0;l<o.length;l++){var u=o[l];h.put(u.mode,4),h.put(u.getLength(),s.getLengthInBits(u.mode,t)),u.write(h)}var g=0;for(l=0;l<a.length;l++)g+=a[l].dataCount;if(h.getLengthInBits()>8*g)throw new Error("code length overflow. ("+h.getLengthInBits()+">"+8*g+")");for(h.getLengthInBits()+4<=8*g&&h.put(0,4);h.getLengthInBits()%8!=0;)h.putBit(!1);for(;!(h.getLengthInBits()>=8*g||(h.put(e.PAD0,8),h.getLengthInBits()>=8*g));)h.put(e.PAD1,8);return e.createBytes(h,a)},e.createBytes=function(t,e){for(var r=0,o=0,i=0,n=new Array(e.length),h=new Array(e.length),l=0;l<e.length;l++){var u=e[l].dataCount,g=e[l].totalCount-u;o=Math.max(o,u),i=Math.max(i,g),n[l]=new Array(u);for(var f=0;f<n[l].length;f++)n[l][f]=255&t.buffer[f+r];r+=u;var c=s.getErrorCorrectPolynomial(g),d=new a(n[l],c.getLength()-1).mod(c);h[l]=new Array(c.getLength()-1);for(f=0;f<h[l].length;f++){var m=f+d.getLength()-h[l].length;h[l][f]=m>=0?d.get(m):0}}var p=0;for(f=0;f<e.length;f++)p+=e[f].totalCount;var v=new Array(p),C=0;for(f=0;f<o;f++)for(l=0;l<e.length;l++)f<n[l].length&&(v[C++]=n[l][f]);for(f=0;f<i;f++)for(l=0;l<e.length;l++)f<h[l].length&&(v[C++]=h[l][f]);return v};for(var r={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},o=function(t){this.mode=r.MODE_8BIT_BYTE,this.data=t,this.parsedData=[];for(var e=0,o=this.data.length;e<o;e++){var i=[],n=this.data.charCodeAt(e);n>65536?(i[0]=240|(1835008&n)>>>18,i[1]=128|(258048&n)>>>12,i[2]=128|(4032&n)>>>6,i[3]=128|63&n):n>2048?(i[0]=224|(61440&n)>>>12,i[1]=128|(4032&n)>>>6,i[2]=128|63&n):n>128?(i[0]=192|(1984&n)>>>6,i[1]=128|63&n):i[0]=n,this.parsedData.push(i)}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))},i={getRSBlocks:function(t,e){var r=function(t,e){switch(e){case d.L:return l[4*(t-1)+0];case d.M:return l[4*(t-1)+1];case d.Q:return l[4*(t-1)+2];case d.H:return l[4*(t-1)+3];default:return}}(t,e);if(null==r)throw new Error("bad rs block @ typeNumber:"+t+"/errorCorrectLevel:"+e);for(var o=r.length/3,i=[],n=0;n<o;n++)for(var a=r[3*n+0],s=r[3*n+1],h=r[3*n+2],u=0;u<a;u++)i.push({totalCount:s,dataCount:h});return i}},n=function(){this.buffer=[],this.length=0},a=function(t,e){if(null==t.length)throw new Error(t.length+"/"+e);for(var r=0;r<t.length&&0==t[r];)r++;this.num=new Array(t.length-r+e);for(var o=0;o<t.length-r;o++)this.num[o]=t[o+r]},s={glog:function(t){if(t<1)throw new Error("glog("+t+")");return u[t]},gexp:function(t){for(;t<0;)t+=255;for(;t>=256;)t-=255;return g[t]},EXP_TABLE:g,LOG_TABLE:u,getBCHTypeInfo:function(t){for(var e=t<<10;s.getBCHDigit(e)-s.getBCHDigit(1335)>=0;)e^=1335<<s.getBCHDigit(e)-s.getBCHDigit(1335);return(t<<10|e)^21522},getBCHTypeNumber:function(t){for(var e=t<<12;s.getBCHDigit(e)-s.getBCHDigit(7973)>=0;)e^=7973<<s.getBCHDigit(e)-s.getBCHDigit(7973);return t<<12|e},getBCHDigit:function(t){for(var e=0;0!=t;)e++,t>>>=1;return e},getPatternPosition:function(t){return f[t-1]},getMask:function(t,e,r){switch(t){case 0:return(e+r)%2==0;case 1:return e%2==0;case 2:return r%3==0;case 3:return(e+r)%3==0;case 4:return(Math.floor(e/2)+Math.floor(r/3))%2==0;case 5:return e*r%2+e*r%3==0;case 6:return(e*r%2+e*r%3)%2==0;case 7:return(e*r%3+(e+r)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}},getErrorCorrectPolynomial:function(t){for(var e=new a([1],0),r=0;r<t;r++)e=e.multiply(new a([1,s.gexp(r)],0));return e},getLengthInBits:function(t,e){if(1<=e&&e<10)switch(t){case r.MODE_NUMBER:return 10;case r.MODE_ALPHA_NUM:return 9;case r.MODE_8BIT_BYTE:case r.MODE_KANJI:return 8;default:throw new Error("mode:"+t)}else if(e<27)switch(t){case r.MODE_NUMBER:return 12;case r.MODE_ALPHA_NUM:return 11;case r.MODE_8BIT_BYTE:return 16;case r.MODE_KANJI:return 10;default:throw new Error("mode:"+t)}else{if(!(e<41))throw new Error("type:"+e);switch(t){case r.MODE_NUMBER:return 14;case r.MODE_ALPHA_NUM:return 13;case r.MODE_8BIT_BYTE:return 16;case r.MODE_KANJI:return 12;default:throw new Error("mode:"+t)}}},getLostPoint:function(t){for(var e=t.getModuleCount(),r=0,o=0;o<e;o++)for(var i=0;i<e;i++){for(var n=0,a=t.isDark(o,i),s=-1;s<=1;s++)if(!(o+s<0||e<=o+s))for(var h=-1;h<=1;h++)i+h<0||e<=i+h||0==s&&0==h||a==t.isDark(o+s,i+h)&&n++;n>5&&(r+=3+n-5)}for(o=0;o<e-1;o++)for(i=0;i<e-1;i++){var l=0;t.isDark(o,i)&&l++,t.isDark(o+1,i)&&l++,t.isDark(o,i+1)&&l++,t.isDark(o+1,i+1)&&l++,0!=l&&4!=l||(r+=3)}for(o=0;o<e;o++)for(i=0;i<e-6;i++)t.isDark(o,i)&&!t.isDark(o,i+1)&&t.isDark(o,i+2)&&t.isDark(o,i+3)&&t.isDark(o,i+4)&&!t.isDark(o,i+5)&&t.isDark(o,i+6)&&(r+=40);for(i=0;i<e;i++)for(o=0;o<e-6;o++)t.isDark(o,i)&&!t.isDark(o+1,i)&&t.isDark(o+2,i)&&t.isDark(o+3,i)&&t.isDark(o+4,i)&&!t.isDark(o+5,i)&&t.isDark(o+6,i)&&(r+=40);var u=0;for(i=0;i<e;i++)for(o=0;o<e;o++)t.isDark(o,i)&&u++;return r+=10*(Math.abs(100*u/e/e-50)/5)}},h={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7},l=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],u=function(){for(var t=new Array(256),e=0;e<8;e++)t[e]=1<<e;for(e=8;e<256;e++)t[e]=t[e-4]^t[e-5]^t[e-6]^t[e-8];return t}(),g=function(){for(var t=new Array(255),e=0;e<255;e++)t[u[e]]=e;return t}(),f=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],c={L:1,M:0,Q:3,H:2},d={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};o.prototype={getLength:function(){return this.parsedData.length},write:function(t){for(var e=0,r=this.parsedData.length;e<r;e++)t.put(this.parsedData[e],8)}},n.prototype={get:function(t){var e=Math.floor(t/8);return 1==(this.buffer[e]>>>7-t%8&1)},put:function(t,e){for(var r=0;r<e;r++)this.putBit(1==(t>>>e-r-1&1))},getLengthInBits:function(){return this.length},putBit:function(t){var e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),t&&(this.buffer[e]|=128>>>this.length%8),this.length++}},a.prototype={get:function(t){return this.num[t]},getLength:function(){return this.num.length},multiply:function(t){for(var e=new Array(this.getLength()+t.getLength()-1),r=0;r<this.getLength();r++)for(var o=0;o<t.getLength();o++)e[r+o]^=s.gexp(s.glog(this.get(r))+s.glog(t.get(o)));return new a(e,0)},mod:function(t){if(this.getLength()-t.getLength()<0)return this;for(var e=s.glog(this.get(0))-s.glog(t.get(0)),r=new Array(this.getLength()),o=0;o<this.getLength();o++)r[o]=this.get(o);for(o=0;o<t.getLength();o++)r[o]^=s.gexp(s.glog(t.get(o))+e);return new a(r,0).mod(t)}},window.QRCode=t,QRCode.CorrectLevel=c}();
    </script>

    <!-- Application Script -->
    <script>
        // QR Data Sender Application
        class QRDataSender {
            constructor() {
                this.initializeElements();
                this.initializeEventListeners();
                this.config = {
                    maxChunkSize: 800,
                    interval: 1500,
                    qrSize: 256,
                    errorCorrectionLevel: 'M'
                };
                this.frames = [];
                this.currentFrame = 0;
                this.playbackInterval = null;
                this.isPlaying = false;
            }

            initializeElements() {
                // Input elements
                this.textInput = document.getElementById('textInput');
                this.fileInput = document.getElementById('fileInput');
                
                // Control buttons
                this.generateBtn = document.getElementById('generateBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.playBtn = document.getElementById('playBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.stopBtn = document.getElementById('stopBtn');
                
                // Display elements
                this.qrDisplay = document.getElementById('qrDisplay');
                this.statusContainer = document.getElementById('statusContainer');
                this.progressSection = document.getElementById('progressSection');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                
                // Setting elements
                this.intervalInput = document.getElementById('intervalInput');
                this.intervalDisplay = document.getElementById('intervalDisplay');
                this.qrSizeInput = document.getElementById('qrSizeInput');
                this.qrSizeDisplay = document.getElementById('qrSizeDisplay');
            }

            initializeEventListeners() {
                this.generateBtn.addEventListener('click', () => this.generateQRCode());
                this.clearBtn.addEventListener('click', () => this.clearAll());
                this.playBtn.addEventListener('click', () => this.startPlayback());
                this.pauseBtn.addEventListener('click', () => this.pausePlayback());
                this.stopBtn.addEventListener('click', () => this.stopPlayback());
                
                this.intervalInput.addEventListener('input', (e) => {
                    this.config.interval = parseInt(e.target.value);
                    this.intervalDisplay.textContent = `${e.target.value}ms`;
                });
                
                this.qrSizeInput.addEventListener('input', (e) => {
                    this.config.qrSize = parseInt(e.target.value);
                    this.qrSizeDisplay.textContent = `${e.target.value}px`;
                });

                // File input disabled for Phase 1
                this.fileInput.disabled = true;
            }

            generateQRCode() {
                const text = this.textInput.value.trim();
                
                if (!text) {
                    this.showStatus('请输入要传输的文本', 'warning');
                    return;
                }

                // 数据验证
                if (text.length > 10000) {
                    this.showStatus('数据过大，请减少文本长度', 'error');
                    return;
                }

                try {
                    this.showStatus('正在生成二维码...', 'info');
                    
                    // 添加错误恢复机制
                    let retryCount = 0;
                    const maxRetries = 3;
                    let success = false;
                    
                    while (retryCount < maxRetries && !success) {
                        try {
                            // Phase 1: Simple single QR code (no chunking yet)
                            this.frames = [text]; // Single frame for now
                            this.displayQRCode(text, 0);
                            success = true;
                        } catch (innerError) {
                            retryCount++;
                            console.warn(`QR生成重试 ${retryCount}/${maxRetries}:`, innerError);
                            if (retryCount >= maxRetries) {
                                throw innerError;
                            }
                        }
                    }
                    
                    // Enable playback controls
                    this.playBtn.disabled = false;
                    this.pauseBtn.disabled = false;
                    this.stopBtn.disabled = false;
                    
                    this.showStatus(`二维码生成成功 (${text.length} 个字符)`, 'info');
                    
                } catch (error) {
                    console.error('QR Generation Error:', error);
                    this.showStatus('生成二维码错误: ' + error.message, 'error');
                    // 清理状态
                    this.qrDisplay.innerHTML = '';
                    this.frames = [];
                }
            }

            displayQRCode(data, frameIndex = 0) {
                try {
                    // Clear existing QR display
                    this.qrDisplay.innerHTML = '';
                    
                    // Create canvas element
                    const canvas = document.createElement('canvas');
                    canvas.width = this.config.qrSize;
                    canvas.height = this.config.qrSize;
                    
                    // Generate QR code using embedded library
                    const qrcode = new QRCode(canvas, {
                        text: data,
                        width: this.config.qrSize,
                        height: this.config.qrSize,
                        correctLevel: QRCode.CorrectLevel[this.config.errorCorrectionLevel]
                    });
                    
                    // Update progress
                    this.updateProgress(frameIndex + 1, this.frames.length);
                    
                } catch (error) {
                    console.error('Display Error:', error);
                    this.showStatus('显示二维码错误: ' + error.message, 'error');
                }
            }

            startPlayback() {
                if (this.frames.length === 0) {
                    this.showStatus('没有二维码可播放，请先生成', 'warning');
                    return;
                }

                this.isPlaying = true;
                this.playBtn.disabled = true;
                this.pauseBtn.disabled = false;
                this.progressSection.style.display = 'block';
                
                // For Phase 1, just display the single QR code
                this.displayQRCode(this.frames[0], 0);
                this.showStatus('播放二维码 (第一阶段：单帧)', 'info');
            }

            pausePlayback() {
                this.isPlaying = false;
                this.playBtn.disabled = false;
                this.pauseBtn.disabled = true;
                
                if (this.playbackInterval) {
                    clearInterval(this.playbackInterval);
                    this.playbackInterval = null;
                }
                
                this.showStatus('播放已暂停', 'info');
            }

            stopPlayback() {
                this.isPlaying = false;
                this.playBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.currentFrame = 0;
                
                if (this.playbackInterval) {
                    clearInterval(this.playbackInterval);
                    this.playbackInterval = null;
                }
                
                this.progressSection.style.display = 'none';
                this.qrDisplay.innerHTML = '<div class="qr-placeholder">播放已停止</div>';
                this.showStatus('播放已停止', 'info');
            }

            updateProgress(current, total) {
                if (total > 0) {
                    const percentage = (current / total) * 100;
                    this.progressFill.style.width = `${percentage}%`;
                    this.progressText.textContent = `帧 ${current} / ${total}`;
                }
            }

            clearAll() {
                this.textInput.value = '';
                this.fileInput.value = '';
                this.frames = [];
                this.currentFrame = 0;
                this.stopPlayback();
                
                this.qrDisplay.innerHTML = '<div class="qr-placeholder">二维码将在此显示</div>';
                this.progressSection.style.display = 'none';
                
                this.playBtn.disabled = true;
                this.pauseBtn.disabled = true;
                this.stopBtn.disabled = true;
                
                this.showStatus('所有数据已清除', 'info');
            }

            showStatus(message, type = 'info') {
                this.statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
                
                // Auto-hide non-error messages after 5 seconds
                if (type !== 'error') {
                    setTimeout(() => {
                        if (this.statusContainer.innerHTML.includes(message)) {
                            this.statusContainer.innerHTML = '<div class="status info">准备就绪</div>';
                        }
                    }, 5000);
                }
            }
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.qrSender = new QRDataSender();
            
            // Set default test text for easy testing
            document.getElementById('textInput').value = 'Hello World! 这是QR码数据传输系统的测试消息。';
        });
    </script>
</body>
</html>