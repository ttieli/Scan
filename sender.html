<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR数据发送器 - 内网数据传输</title>
    <meta name="description" content="通过二维码安全传输内网数据到外部设备">
    <!-- PWA支持 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/x-icon" href="public/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" href="public/icons/apple-touch-icon.png">
    
    <style>
        /* QR Data Transfer System - Sender Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group textarea,
        .input-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .input-group textarea:focus,
        .input-group input[type="file"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .input-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.9rem;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .qr-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-display canvas {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .qr-placeholder {
            color: #666;
            font-style: italic;
        }

        .progress-section {
            margin-top: 20px;
        }

        .progress-bar {
            background: #ecf0f1;
            border-radius: 20px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.info {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .controls .btn {
            flex: 1;
            min-width: 120px;
        }

        input[type="range"] {
            width: 200px;
            margin: 0 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .section {
                padding: 20px 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            input[type="range"] {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>QR数据发送器</h1>
            <p>通过二维码将内网数据传输到外部设备</p>
        </div>

        <!-- 输入区域 -->
        <div class="section">
            <h2>数据输入</h2>
            
            <div class="input-group">
                <label for="textInput">文本内容</label>
                <textarea 
                    id="textInput" 
                    placeholder="输入要传输的文本... (例如: Hello World)"
                    maxlength="10000"></textarea>
                <small>第一阶段最多支持10,000个字符</small>
            </div>

            <div class="input-group">
                <label for="fileInput">文件上传</label>
                <input type="file" id="fileInput" accept="*/*">
                <small>文件支持将在第三阶段提供</small>
            </div>

            <div class="controls">
                <button class="btn" id="generateBtn">生成二维码</button>
                <button class="btn btn-secondary" id="clearBtn">清除所有</button>
            </div>
        </div>

        <!-- 二维码显示区域 -->
        <div class="section">
            <h2>二维码显示</h2>
            
            <div class="qr-display" id="qrDisplay">
                <div class="qr-placeholder">二维码将在此显示</div>
            </div>

            <div class="controls">
                <button class="btn" id="playBtn" disabled>开始播放</button>
                <button class="btn btn-secondary" id="pauseBtn" disabled>暂停</button>
                <button class="btn btn-secondary" id="stopBtn" disabled>停止</button>
            </div>

            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">帧 0 / 0</div>
            </div>
        </div>

        <!-- 设置区域 -->
        <div class="section">
            <h2>设置</h2>
            
            <div class="input-group">
                <label for="intervalInput">播放间隔 (毫秒)</label>
                <input type="range" id="intervalInput" min="500" max="3000" value="1500" step="100">
                <span id="intervalDisplay">1500ms</span>
            </div>

            <div class="input-group">
                <label for="qrSizeInput">二维码尺寸 (像素)</label>
                <input type="range" id="qrSizeInput" min="128" max="512" value="256" step="32">
                <span id="qrSizeDisplay">256px</span>
            </div>
        </div>

        <!-- 状态区域 -->
        <div class="section">
            <h2>状态</h2>
            <div id="statusContainer">
                <div class="status info">准备生成二维码</div>
            </div>
        </div>
    </div>

    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- QRCode.js Library (embedded for offline use) -->
    <script>
        // QRCode.js v1.5.3 - Minimal embedded version for offline use
        // Full library: https://github.com/davidshimjs/qrcodejs
        // Load QRCode.js from CDN
        (function() {
            var script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
            script.onload = function() {
                console.log('QRCode.js loaded successfully');
            };
            script.onerror = function() {
                console.error('Failed to load QRCode.js from CDN');
            };
            document.head.appendChild(script);
        })();
    </script>

    <!-- Application Script -->
    <script>
        // QR Data Sender Application
        class QRDataSender {
            constructor() {
                this.initializeElements();
                this.initializeEventListeners();
                this.config = {
                    maxChunkSize: 800,
                    interval: 1500,
                    qrSize: 256,
                    errorCorrectionLevel: 'M'
                };
                this.frames = [];
                this.currentFrame = 0;
                this.playbackInterval = null;
                this.isPlaying = false;
            }

            initializeElements() {
                // Input elements
                this.textInput = document.getElementById('textInput');
                this.fileInput = document.getElementById('fileInput');
                
                // Control buttons
                this.generateBtn = document.getElementById('generateBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.playBtn = document.getElementById('playBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.stopBtn = document.getElementById('stopBtn');
                
                // Display elements
                this.qrDisplay = document.getElementById('qrDisplay');
                this.statusContainer = document.getElementById('statusContainer');
                this.progressSection = document.getElementById('progressSection');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                
                // Setting elements
                this.intervalInput = document.getElementById('intervalInput');
                this.intervalDisplay = document.getElementById('intervalDisplay');
                this.qrSizeInput = document.getElementById('qrSizeInput');
                this.qrSizeDisplay = document.getElementById('qrSizeDisplay');
            }

            initializeEventListeners() {
                this.generateBtn.addEventListener('click', () => this.generateQRCode());
                this.clearBtn.addEventListener('click', () => this.clearAll());
                this.playBtn.addEventListener('click', () => this.startPlayback());
                this.pauseBtn.addEventListener('click', () => this.pausePlayback());
                this.stopBtn.addEventListener('click', () => this.stopPlayback());
                
                this.intervalInput.addEventListener('input', (e) => {
                    this.config.interval = parseInt(e.target.value);
                    this.intervalDisplay.textContent = `${e.target.value}ms`;
                });
                
                this.qrSizeInput.addEventListener('input', (e) => {
                    this.config.qrSize = parseInt(e.target.value);
                    this.qrSizeDisplay.textContent = `${e.target.value}px`;
                });

                // File input disabled for Phase 1
                this.fileInput.disabled = true;
            }

            generateQRCode() {
                const text = this.textInput.value.trim();
                
                if (!text) {
                    this.showStatus('请输入要传输的文本', 'warning');
                    return;
                }

                // 数据验证
                if (text.length > 10000) {
                    this.showStatus('数据过大，请减少文本长度', 'error');
                    return;
                }

                try {
                    this.showStatus('正在生成二维码...', 'info');
                    
                    // 添加错误恢复机制
                    let retryCount = 0;
                    const maxRetries = 3;
                    let success = false;
                    
                    while (retryCount < maxRetries && !success) {
                        try {
                            // Phase 1: Simple single QR code (no chunking yet)
                            this.frames = [text]; // Single frame for now
                            this.displayQRCode(text, 0);
                            success = true;
                        } catch (innerError) {
                            retryCount++;
                            console.warn(`QR生成重试 ${retryCount}/${maxRetries}:`, innerError);
                            if (retryCount >= maxRetries) {
                                throw innerError;
                            }
                        }
                    }
                    
                    // Enable playback controls
                    this.playBtn.disabled = false;
                    this.pauseBtn.disabled = false;
                    this.stopBtn.disabled = false;
                    
                    this.showStatus(`二维码生成成功 (${text.length} 个字符)`, 'info');
                    
                } catch (error) {
                    console.error('QR Generation Error:', error);
                    this.showStatus('生成二维码错误: ' + error.message, 'error');
                    // 清理状态
                    this.qrDisplay.innerHTML = '';
                    this.frames = [];
                }
            }

            displayQRCode(data, frameIndex = 0) {
                try {
                    // Clear existing QR display
                    this.qrDisplay.innerHTML = '';
                    
                    // Create canvas element
                    const canvas = document.createElement('canvas');
                    canvas.width = this.config.qrSize;
                    canvas.height = this.config.qrSize;
                    
                    // Generate QR code using embedded library
                    const qrcode = new QRCode(canvas, {
                        text: data,
                        width: this.config.qrSize,
                        height: this.config.qrSize,
                        correctLevel: QRCode.CorrectLevel[this.config.errorCorrectionLevel]
                    });
                    
                    // Update progress
                    this.updateProgress(frameIndex + 1, this.frames.length);
                    
                } catch (error) {
                    console.error('Display Error:', error);
                    this.showStatus('显示二维码错误: ' + error.message, 'error');
                }
            }

            startPlayback() {
                if (this.frames.length === 0) {
                    this.showStatus('没有二维码可播放，请先生成', 'warning');
                    return;
                }

                this.isPlaying = true;
                this.playBtn.disabled = true;
                this.pauseBtn.disabled = false;
                this.progressSection.style.display = 'block';
                
                // For Phase 1, just display the single QR code
                this.displayQRCode(this.frames[0], 0);
                this.showStatus('播放二维码 (第一阶段：单帧)', 'info');
            }

            pausePlayback() {
                this.isPlaying = false;
                this.playBtn.disabled = false;
                this.pauseBtn.disabled = true;
                
                if (this.playbackInterval) {
                    clearInterval(this.playbackInterval);
                    this.playbackInterval = null;
                }
                
                this.showStatus('播放已暂停', 'info');
            }

            stopPlayback() {
                this.isPlaying = false;
                this.playBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.currentFrame = 0;
                
                if (this.playbackInterval) {
                    clearInterval(this.playbackInterval);
                    this.playbackInterval = null;
                }
                
                this.progressSection.style.display = 'none';
                this.qrDisplay.innerHTML = '<div class="qr-placeholder">播放已停止</div>';
                this.showStatus('播放已停止', 'info');
            }

            updateProgress(current, total) {
                if (total > 0) {
                    const percentage = (current / total) * 100;
                    this.progressFill.style.width = `${percentage}%`;
                    this.progressText.textContent = `帧 ${current} / ${total}`;
                }
            }

            clearAll() {
                this.textInput.value = '';
                this.fileInput.value = '';
                this.frames = [];
                this.currentFrame = 0;
                this.stopPlayback();
                
                this.qrDisplay.innerHTML = '<div class="qr-placeholder">二维码将在此显示</div>';
                this.progressSection.style.display = 'none';
                
                this.playBtn.disabled = true;
                this.pauseBtn.disabled = true;
                this.stopBtn.disabled = true;
                
                this.showStatus('所有数据已清除', 'info');
            }

            showStatus(message, type = 'info') {
                this.statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
                
                // Auto-hide non-error messages after 5 seconds
                if (type !== 'error') {
                    setTimeout(() => {
                        if (this.statusContainer.innerHTML.includes(message)) {
                            this.statusContainer.innerHTML = '<div class="status info">准备就绪</div>';
                        }
                    }, 5000);
                }
            }
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.qrSender = new QRDataSender();
            
            // Set default test text for easy testing
            document.getElementById('textInput').value = 'Hello World! 这是QR码数据传输系统的测试消息。';
        });
    </script>
</body>
</html>