<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QRæ¥æ”¶ç«¯ - æ–‡ä»¶ä¼ è¾“ç‰ˆ</title>
<style>
/* æ ·å¼ */
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
    margin: 0; 
    padding: 10px; 
    background: #f5f5f5; 
    -webkit-text-size-adjust: 100%;
}
.container { 
    max-width: 800px; 
    margin: 0 auto; 
}
.section { 
    background: white; 
    padding: 15px; 
    margin-bottom: 15px; 
    border-radius: 10px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.btn { 
    background: #4CAF50; 
    color: white; 
    border: none; 
    padding: 12px 24px; 
    border-radius: 6px; 
    cursor: pointer; 
    font-size: 16px;
    width: 100%;
    margin-bottom: 10px;
}
.btn:active { background: #45a049; }
.btn-secondary {
    background: #6c757d;
}
.btn-secondary:active { background: #5a6268; }
.btn-danger {
    background: #dc3545;
}
.btn-danger:active { background: #c82333; }

.video-container {
    position: relative;
    width: 100%;
    max-width: 320px;
    margin: 10px auto;
    overflow: hidden;
    border-radius: 10px;
}

#video { 
    width: 100%; 
    height: auto;
    display: block;
    background: #000;
    object-fit: cover;
    transition: all 0.3s ease;
}

/* iOS Safari ä¸“å±æ ·å¼ */
@supports (-webkit-touch-callout: none) {
    #video {
        width: 100% !important;
        height: auto !important;
    }
    
    .video-container {
        max-width: 320px;
        max-height: 240px;
        aspect-ratio: 4/3;
    }
}

#video.hidden {
    display: none !important;
}

#video.minimized {
    max-width: 200px;
    max-height: 150px;
    opacity: 0.8;
}

.video-controls {
    display: flex;
    gap: 10px;
    margin: 10px 0;
    align-items: center;
    flex-wrap: wrap;
}

.video-controls button {
    background: #6c757d;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    flex: 1;
    min-width: 80px;
}

.video-controls button:active { background: #5a6268; }

#canvas {
    display: none;
    border: 2px dashed #ccc;
}

.status {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    font-family: 'Courier New', monospace;
}

.status.success { background: #d4edda; color: #155724; }
.status.error { background: #f8d7da; color: #721c24; }
.status.warning { background: #fff3cd; color: #856404; }

.progress {
    background: #e0e0e0;
    border-radius: 10px;
    padding: 3px;
    margin: 10px 0;
    height: 30px;
}

.progress-bar {
    background: #4CAF50;
    height: 24px;
    border-radius: 8px;
    transition: width 0.3s;
    text-align: center;
    line-height: 24px;
    color: white;
    font-size: 12px;
}

#result {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    min-height: 100px;
    word-wrap: break-word;
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
}

.chunk-info {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    margin: 10px 0;
}

.chunk-info span {
    font-size: 14px;
    color: #666;
}

.file-info {
    background: #e7f5ff;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border: 1px solid #74c0fc;
}

.file-info h3 {
    margin-top: 0;
    color: #1864ab;
}

.file-info p {
    margin: 5px 0;
    color: #495057;
}

.download-section {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
    margin-top: 20px;
    border: 2px dashed #6c757d;
}

.download-section.ready {
    background: #d1f4e0;
    border-color: #4CAF50;
}

.download-btn {
    display: inline-block;
    padding: 15px 30px;
    background: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
}

.download-btn:hover {
    background: #218838;
}

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.tab {
    flex: 1;
    padding: 10px;
    background: #e0e0e0;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    text-align: center;
}

.tab.active {
    background: white;
    border-bottom: 2px solid #4CAF50;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

.stat-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #666;
}

.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #2c3e50;
}

@media (max-width: 480px) {
    .container {
        padding: 5px;
    }
    
    .section {
        padding: 10px;
        margin-bottom: 10px;
    }
    
    .btn {
        padding: 10px 15px;
        font-size: 14px;
    }
    
    .video-container {
        max-width: 100%;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="section">
        <h2>ğŸ“¥ QRæ¥æ”¶å™¨ - æ–‡ä»¶ä¼ è¾“ç‰ˆ</h2>
        <p>æ”¯æŒæ–‡æœ¬å’Œæ–‡ä»¶æ¥æ”¶</p>
        <p style="font-size: 11px; color: #999;">ç‰ˆæœ¬: 2025-09-04 | æ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶ä¼ è¾“</p>
    </div>

    <div class="section">
        <h3>æ‘„åƒå¤´æ‰«æ</h3>
        
        <div class="video-container">
            <video id="video" autoplay playsinline></video>
        </div>
        
        <div class="video-controls">
            <button onclick="toggleCamera()">åˆ‡æ¢æ‘„åƒå¤´</button>
            <button onclick="toggleSize()">è°ƒæ•´å¤§å°</button>
            <button onclick="toggleVideo()">éšè—/æ˜¾ç¤º</button>
        </div>
        
        <canvas id="canvas"></canvas>
        
        <button class="btn" onclick="startScanning()" id="startBtn">å¼€å§‹æ‰«æ</button>
        <button class="btn btn-danger" onclick="stopScanning()" id="stopBtn" style="display:none;">åœæ­¢æ‰«æ</button>
        <button class="btn btn-secondary" onclick="clearData()" id="clearBtn">æ¸…ç©ºæ•°æ®</button>
    </div>

    <div class="section">
        <h3>ä¼ è¾“çŠ¶æ€</h3>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">æ•°æ®ç±»å‹</div>
                <div class="stat-value" id="dataType">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ¥æ”¶è¿›åº¦</div>
                <div class="stat-value" id="progress">0%</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">åˆ†ç‰‡æ•°é‡</div>
                <div class="stat-value" id="chunkCount">0/0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ€»å¤§å°</div>
                <div class="stat-value" id="totalSize">-</div>
            </div>
        </div>
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
        </div>
        <div id="status" class="status">ç­‰å¾…æ‰«æ...</div>
    </div>

    <div class="section" id="textSection" style="display: none;">
        <h3>æ¥æ”¶çš„æ–‡æœ¬</h3>
        <div id="result"></div>
        <button class="btn btn-secondary" onclick="copyText()" style="margin-top: 10px;">å¤åˆ¶æ–‡æœ¬</button>
    </div>

    <div class="section" id="fileSection" style="display: none;">
        <h3>æ¥æ”¶çš„æ–‡ä»¶</h3>
        <div class="file-info" id="fileInfo" style="display: none;">
            <h3>æ–‡ä»¶ä¿¡æ¯</h3>
            <p id="fileName">æ–‡ä»¶å: -</p>
            <p id="fileSize">å¤§å°: -</p>
            <p id="fileType">ç±»å‹: -</p>
            <p id="fileModified">ä¿®æ”¹æ—¶é—´: -</p>
        </div>
        <div class="download-section" id="downloadSection" style="display: none;">
            <h3>æ–‡ä»¶å‡†å¤‡å°±ç»ª</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½æ–‡ä»¶</p>
            <a id="downloadLink" class="download-btn" download>ä¸‹è½½æ–‡ä»¶</a>
        </div>
    </div>

    <div class="section">
        <h3>è°ƒè¯•ä¿¡æ¯</h3>
        <div class="chunk-info">
            <span>å·²æ¥æ”¶: <strong id="receivedChunks">0</strong></span>
            <span>æ€»åˆ†ç‰‡: <strong id="totalChunks">0</strong></span>
            <span>æ‰«æé€Ÿåº¦: <strong id="scanSpeed">0</strong> ç‰‡/ç§’</span>
        </div>
    </div>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
// å¦‚æœCDNå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½
if (typeof jsQR === 'undefined') {
    console.error('jsQRåº“åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥æˆ–ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬');
    // è¿™é‡Œå¯ä»¥æ·»åŠ æœ¬åœ°jsQRåº“çš„å†…åµŒç‰ˆæœ¬
}

let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let scanning = false;
let chunks = {};
let totalChunks = 0;
let scanCount = 0;
let lastScanTime = Date.now();
let currentCameraIndex = 0;
let cameras = [];
let receivedData = null;
let fileMetadata = null;
let dataType = 'text';

// åˆå§‹åŒ–æ‘„åƒå¤´
async function initCamera() {
    try {
        // è·å–æ‰€æœ‰æ‘„åƒå¤´
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(device => device.kind === 'videoinput');
        
        if (cameras.length === 0) {
            throw new Error('æ²¡æœ‰æ‰¾åˆ°æ‘„åƒå¤´');
        }
        
        // å¯åŠ¨é»˜è®¤æ‘„åƒå¤´
        await switchCamera(0);
        
        updateStatus('æ‘„åƒå¤´å·²å°±ç»ª', 'success');
    } catch (err) {
        console.error('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', err);
        updateStatus('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥: ' + err.message, 'error');
    }
}

// åˆ‡æ¢æ‘„åƒå¤´
async function switchCamera(index) {
    if (cameras.length === 0) return;
    
    currentCameraIndex = index % cameras.length;
    
    const constraints = {
        video: {
            deviceId: { exact: cameras[currentCameraIndex].deviceId },
            width: { ideal: 640 },
            height: { ideal: 480 }
        }
    };
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½
        await new Promise(resolve => {
            video.onloadedmetadata = resolve;
        });
        
        // è®¾ç½®canvaså°ºå¯¸
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    } catch (err) {
        console.error('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', err);
        updateStatus('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥', 'error');
    }
}

// åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’®
function toggleCamera() {
    switchCamera(currentCameraIndex + 1);
}

// åˆ‡æ¢è§†é¢‘å¤§å°
function toggleSize() {
    video.classList.toggle('minimized');
}

// æ˜¾ç¤º/éšè—è§†é¢‘
function toggleVideo() {
    video.classList.toggle('hidden');
}

// å¼€å§‹æ‰«æ
function startScanning() {
    if (!video.srcObject) {
        initCamera().then(() => {
            startScanning();
        });
        return;
    }
    
    scanning = true;
    chunks = {};
    totalChunks = 0;
    receivedData = null;
    fileMetadata = null;
    
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'block';
    
    updateStatus('æ‰«æä¸­...', 'warning');
    scanQRCode();
}

// åœæ­¢æ‰«æ
function stopScanning() {
    scanning = false;
    document.getElementById('startBtn').style.display = 'block';
    document.getElementById('stopBtn').style.display = 'none';
    
    updateStatus('æ‰«æå·²åœæ­¢', 'success');
}

// æ‰«æQRç 
function scanQRCode() {
    if (!scanning) return;
    
    // ç¡®ä¿è§†é¢‘å·²å‡†å¤‡å¥½
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
        });
        
        if (code) {
            processQRCode(code.data);
            
            // è®¡ç®—æ‰«æé€Ÿåº¦
            scanCount++;
            const now = Date.now();
            if (now - lastScanTime > 1000) {
                document.getElementById('scanSpeed').textContent = scanCount;
                scanCount = 0;
                lastScanTime = now;
            }
        }
    }
    
    requestAnimationFrame(scanQRCode);
}

// å¤„ç†æ‰«æåˆ°çš„QRç 
function processQRCode(data) {
    try {
        const parsed = JSON.parse(data);
        
        // æ£€æŸ¥åè®®ç‰ˆæœ¬
        if (parsed.v === 2) {
            // æ–°åè®®ï¼Œæ”¯æŒæ–‡ä»¶ä¼ è¾“
            handleV2Protocol(parsed);
        } else if (parsed.i && parsed.t && parsed.d) {
            // æ—§åè®®ï¼Œä»…æ”¯æŒæ–‡æœ¬
            handleV1Protocol(parsed);
        } else {
            console.error('æœªçŸ¥çš„æ•°æ®æ ¼å¼');
        }
    } catch (e) {
        console.error('è§£æQRç æ•°æ®å¤±è´¥:', e);
    }
}

// å¤„ç†V2åè®®ï¼ˆæ”¯æŒæ–‡ä»¶ï¼‰
function handleV2Protocol(data) {
    const chunkIndex = data.i;
    const total = data.t;
    
    // åˆå§‹åŒ–æ€»åˆ†ç‰‡æ•°
    if (totalChunks === 0) {
        totalChunks = total;
        document.getElementById('totalChunks').textContent = total;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²æ¥æ”¶è¿‡æ­¤åˆ†ç‰‡
    if (chunks[chunkIndex]) {
        return;
    }
    
    // å­˜å‚¨åˆ†ç‰‡
    chunks[chunkIndex] = data.d;
    
    // æ›´æ–°æ•°æ®ç±»å‹
    if (data.type) {
        dataType = data.type;
        document.getElementById('dataType').textContent = dataType === 'file' ? 'æ–‡ä»¶' : 'æ–‡æœ¬';
    }
    
    // æ›´æ–°è¿›åº¦
    const receivedCount = Object.keys(chunks).length;
    updateProgress(receivedCount, totalChunks);
    
    // æ£€æŸ¥æ˜¯å¦æ¥æ”¶å®Œæˆ
    if (receivedCount === totalChunks) {
        assembleData(data.type);
    }
}

// å¤„ç†V1åè®®ï¼ˆä»…æ–‡æœ¬ï¼‰
function handleV1Protocol(data) {
    const chunkIndex = data.i;
    const total = data.t;
    const chunkData = data.e === 'b64' ? atob(data.d) : data.d;
    
    if (totalChunks === 0) {
        totalChunks = total;
        document.getElementById('totalChunks').textContent = total;
    }
    
    if (chunks[chunkIndex]) {
        return;
    }
    
    chunks[chunkIndex] = chunkData;
    
    const receivedCount = Object.keys(chunks).length;
    updateProgress(receivedCount, totalChunks);
    
    if (receivedCount === totalChunks) {
        assembleTextData();
    }
}

// ç»„è£…æ•°æ®
function assembleData(type) {
    if (type === 'file') {
        assembleFileData();
    } else {
        assembleTextData();
    }
}

// ç»„è£…æ–‡æœ¬æ•°æ®
function assembleTextData() {
    let result = '';
    for (let i = 1; i <= totalChunks; i++) {
        if (chunks[i]) {
            result += chunks[i];
        }
    }
    
    // å°è¯•è§£ææ˜¯å¦ä¸ºæ–‡ä»¶æ•°æ®
    try {
        const parsed = JSON.parse(result);
        if (parsed.type === 'file' && parsed.metadata && parsed.data) {
            // è¿™æ˜¯æ–‡ä»¶æ•°æ®
            fileMetadata = parsed.metadata;
            receivedData = parsed.data;
            displayFile();
            return;
        }
    } catch (e) {
        // ä¸æ˜¯JSONï¼Œä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
    }
    
    // æ˜¾ç¤ºæ–‡æœ¬ç»“æœ
    receivedData = result;
    displayText(result);
}

// ç»„è£…æ–‡ä»¶æ•°æ®
function assembleFileData() {
    let result = '';
    for (let i = 1; i <= totalChunks; i++) {
        if (chunks[i]) {
            result += chunks[i];
        }
    }
    
    try {
        const parsed = JSON.parse(result);
        if (parsed.type === 'file' && parsed.metadata && parsed.data) {
            fileMetadata = parsed.metadata;
            receivedData = parsed.data;
            displayFile();
        }
    } catch (e) {
        console.error('è§£ææ–‡ä»¶æ•°æ®å¤±è´¥:', e);
        updateStatus('æ–‡ä»¶æ•°æ®è§£æå¤±è´¥', 'error');
    }
}

// æ˜¾ç¤ºæ–‡æœ¬ç»“æœ
function displayText(text) {
    stopScanning();
    
    document.getElementById('textSection').style.display = 'block';
    document.getElementById('fileSection').style.display = 'none';
    document.getElementById('result').textContent = text;
    
    updateStatus('æ–‡æœ¬æ¥æ”¶å®Œæˆï¼', 'success');
    
    // è®¡ç®—æ–‡æœ¬å¤§å°
    const size = new Blob([text]).size;
    document.getElementById('totalSize').textContent = formatFileSize(size);
}

// æ˜¾ç¤ºæ–‡ä»¶ç»“æœ
function displayFile() {
    stopScanning();
    
    document.getElementById('textSection').style.display = 'none';
    document.getElementById('fileSection').style.display = 'block';
    
    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    const fileInfo = document.getElementById('fileInfo');
    fileInfo.style.display = 'block';
    document.getElementById('fileName').textContent = 'æ–‡ä»¶å: ' + fileMetadata.name;
    document.getElementById('fileSize').textContent = 'å¤§å°: ' + formatFileSize(fileMetadata.size);
    document.getElementById('fileType').textContent = 'ç±»å‹: ' + (fileMetadata.type || 'æœªçŸ¥');
    document.getElementById('fileModified').textContent = 'ä¿®æ”¹æ—¶é—´: ' + new Date(fileMetadata.lastModified).toLocaleString();
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const base64Data = receivedData;
    const byteCharacters = atob(base64Data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: fileMetadata.type || 'application/octet-stream' });
    
    const url = URL.createObjectURL(blob);
    const downloadLink = document.getElementById('downloadLink');
    downloadLink.href = url;
    downloadLink.download = fileMetadata.name;
    
    const downloadSection = document.getElementById('downloadSection');
    downloadSection.style.display = 'block';
    downloadSection.classList.add('ready');
    
    updateStatus('æ–‡ä»¶æ¥æ”¶å®Œæˆï¼', 'success');
    document.getElementById('totalSize').textContent = formatFileSize(fileMetadata.size);
}

// æ›´æ–°è¿›åº¦
function updateProgress(received, total) {
    const percent = Math.round((received / total) * 100);
    
    document.getElementById('receivedChunks').textContent = received;
    document.getElementById('chunkCount').textContent = `${received}/${total}`;
    document.getElementById('progress').textContent = `${percent}%`;
    
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = `${percent}%`;
    progressBar.textContent = `${percent}%`;
}

// æ›´æ–°çŠ¶æ€
function updateStatus(message, type = '') {
    const status = document.getElementById('status');
    status.textContent = message;
    status.className = 'status ' + type;
}

// å¤åˆ¶æ–‡æœ¬
function copyText() {
    const result = document.getElementById('result').textContent;
    navigator.clipboard.writeText(result).then(() => {
        updateStatus('æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        updateStatus('å¤åˆ¶å¤±è´¥', 'error');
    });
}

// æ¸…ç©ºæ•°æ®
function clearData() {
    chunks = {};
    totalChunks = 0;
    receivedData = null;
    fileMetadata = null;
    
    document.getElementById('result').textContent = '';
    document.getElementById('textSection').style.display = 'none';
    document.getElementById('fileSection').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('downloadSection').style.display = 'none';
    document.getElementById('downloadSection').classList.remove('ready');
    
    document.getElementById('receivedChunks').textContent = '0';
    document.getElementById('totalChunks').textContent = '0';
    document.getElementById('chunkCount').textContent = '0/0';
    document.getElementById('progress').textContent = '0%';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').textContent = '0%';
    document.getElementById('dataType').textContent = '-';
    document.getElementById('totalSize').textContent = '-';
    
    updateStatus('æ•°æ®å·²æ¸…ç©º', 'success');
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', () => {
    initCamera();
});

// é¡µé¢å¸è½½æ—¶é‡Šæ”¾èµ„æº
window.addEventListener('beforeunload', () => {
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
});
</script>
</body>
</html>